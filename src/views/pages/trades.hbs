<div class="container-fluid">
  <div class="row g-4">
    <div class="col-12">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center">
        <div>
          {{#if (eq mode 'live')}}
            <h1 class="h3 mb-2">Live Trades for {{strategy.name}}</h1>
            {{#if liveAccount}}
              <p class="text-muted mb-0">
                {{liveAccount.name}}
                &middot;
                {{liveAccount.provider}} / {{liveAccount.environment}}
              </p>
            {{else}}
              <p class="text-muted mb-0">Orders dispatched to your linked brokerage account.</p>
            {{/if}}
          {{else}}
            <h1 class="h3 mb-2">Trades for {{strategy.name}}</h1>
            <p class="text-muted mb-0">
              Backtest {{backtestPeriodLabel}}
              &middot;
              {{formatDate backtest.startDate}} — {{formatDate backtest.endDate}}
            </p>
          {{/if}}
        </div>
        <div class="mt-3 mt-md-0">
          <a href="{{backtestLink}}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>
            {{#if (eq mode 'live')}}Back to Strategy Overview{{else}}Back to Backtest Overview{{/if}}
          </a>
        </div>
      </div>
    </div>

    <div class="col-12 col-xxl-3">
      <div class="card h-100">
        <div class="card-header py-2">
          <h5 class="card-title mb-0">
            <i class="fas fa-chart-line me-2"></i>
            Trade Summary
          </h5>
        </div>
        <div class="card-body py-2">
          <ul class="list-group list-group-flush small">
            {{#each statusSummary}}
              <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                <span class="text-muted">{{label}}</span>
                <span class="fw-bold">{{value}}</span>
              </li>
            {{/each}}
          </ul>
          <div class="mt-2 small text-muted">
            Sorted by {{currentSortLabel}} ({{#if (eq filters.sortDirection 'asc')}}Oldest first{{else}}Newest first{{/if}})
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xxl-9">
      <div class="card">
        <div class="card-header">
          <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center">
            <div>
              <h5 class="card-title mb-1">
                <i class="fas fa-table me-2"></i>
                Trades
              </h5>
              <p class="text-muted mb-0">
                Showing {{pagination.from}}–{{pagination.to}} of {{pagination.total}} trades
              </p>
            </div>
            <form method="get" action="{{tradesPagePath}}" class="d-flex flex-wrap gap-2 mt-3 mt-lg-0">
              <input type="hidden" name="page" value="1">
              {{#if filters.status}}
                <input type="hidden" name="status" value="{{filters.status}}">
              {{/if}}
              {{#if filters.ticker}}
                <input type="hidden" name="ticker" value="{{filters.ticker}}">
              {{/if}}
              <div class="input-group input-group-sm">
                <label class="input-group-text" for="pageSizeSelect">Page Size</label>
                <select class="form-select" id="pageSizeSelect" name="pageSize" onchange="this.form.submit()">
                  {{#each pageSizeOptions}}
                    <option value="{{this}}" {{#if (eq ../filters.pageSize this)}}selected{{/if}}>{{this}}</option>
                  {{/each}}
                </select>
              </div>
            </form>
          </div>
        </div>
        <div class="card-body border-bottom">
          <form method="get" action="{{tradesPagePath}}">
            <input type="hidden" name="page" value="1">
            <div class="row g-3">
              <div class="col-md-3">
                <label for="statusSelect" class="form-label text-muted small mb-1">Status</label>
                <select id="statusSelect" name="status" class="form-select">
                  {{#each statusOptions}}
                    <option value="{{value}}" {{#if (eq ../filters.status value)}}selected{{/if}}>{{label}}</option>
                  {{/each}}
                </select>
              </div>
              <div class="col-md-3">
                <label for="tickerInput" class="form-label text-muted small mb-1">Ticker</label>
                <input id="tickerInput" name="ticker" value="{{filters.ticker}}" class="form-control" placeholder="e.g. AAPL">
              </div>
              <div class="col-md-3">
                <label for="sortSelect" class="form-label text-muted small mb-1">Sort By</label>
                <div class="input-group">
                  <select id="sortSelect" name="sort" class="form-select">
                    {{#each sortOptions}}
                      <option value="{{value}}" {{#if (eq ../filters.sortBy value)}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                  </select>
                  <select name="direction" class="form-select">
                    <option value="desc" {{#if (eq filters.sortDirection 'desc')}}selected{{/if}}>Desc</option>
                    <option value="asc" {{#if (eq filters.sortDirection 'asc')}}selected{{/if}}>Asc</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3 d-flex align-items-end justify-content-end">
                <div class="btn-group w-100">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter me-2"></i>
                    Apply Filters
                  </button>
                  <a href="{{tradesPagePath}}" class="btn btn-outline-secondary">Reset</a>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="table-responsive">
          {{#if trades.length}}
            <table class="table table-sm table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Symbol</th>
                  <th class="text-end">Price</th>
                  <th class="text-end">Qty</th>
                  <th class="text-end">Exit Price</th>
                  <th>Exit Date</th>
                  <th class="text-end">Fee</th>
                  <th class="text-end">Stop Loss</th>
                  <th class="text-end">P&L %</th>
                  <th class="text-center">Status</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                {{#each trades}}
                  <tr class="align-middle">
                    <td class="small">{{formatDate date}}</td>
                    <td class="fw-bold">
                      <a href="/trades/{{id}}" class="text-decoration-none" target="_blank">{{ticker}}</a>
                    </td>
                    <td class="text-end small">${{formatPrice price}}</td>
                    <td class="text-end small">{{quantity}}</td>
                    <td class="text-end small">
                      {{#if exitPrice}}
                        ${{formatPrice exitPrice}}
                      {{else}}
                        <span class="text-muted">N/A</span>
                      {{/if}}
                    </td>
                    <td class="small">
                      {{#if exitDate}}
                        {{formatDate exitDate}}
                      {{else}}
                        <span class="text-muted">N/A</span>
                      {{/if}}
                    </td>
                    <td class="text-end small">
                      {{#if (or fee (eq fee 0))}}
                        {{formatCurrency fee}}
                      {{else}}
                        <span class="text-muted">N/A</span>
                      {{/if}}
                    </td>
                    <td class="text-end small">
                      {{#if stopLoss}}
                        ${{formatPrice stopLoss}}
                        {{#if stopLossTriggered}}
                          <i class="fas fa-exclamation-triangle text-warning ms-1" title="Stop Loss Triggered"></i>
                        {{/if}}
                      {{else}}
                        <span class="text-muted">N/A</span>
                      {{/if}}
                    </td>
                    <td class="text-end">
                      {{#if pnl}}
                        <span class="fw-bold small {{#if (gt pnl 0)}}text-success{{else if (lt pnl 0)}}text-danger{{/if}}">
                          {{formatPnlPercent pnl quantity price}}
                        </span>
                      {{else}}
                        <span class="text-muted small">N/A</span>
                      {{/if}}
                    </td>
                    <td class="text-center">
                      <span class="badge bg-{{#if (eq status 'active')}}success{{else if (eq status 'closed')}}info{{else if (eq status 'cancelled')}}danger{{else if (eq status 'pending')}}warning{{else}}secondary{{/if}}">
                        {{status}}
                      </span>
                    </td>
                    <td class="small">{{formatDate createdAt}}</td>
                  </tr>
                {{/each}}
              </tbody>
            </table>
          {{else}}
            <div class="p-5 text-center text-muted">
              No trades match the current filters.
            </div>
          {{/if}}
        </div>
        <div class="card-footer d-flex flex-column flex-md-row justify-content-between align-items-md-center">
          <div class="text-muted small mb-2 mb-md-0">
            Page {{pagination.page}} of {{pagination.totalPages}}
          </div>
          <div class="btn-group">
            <a class="btn btn-outline-secondary btn-sm {{#unless pagination.firstUrl}}disabled{{/unless}}" href="{{#if pagination.firstUrl}}{{pagination.firstUrl}}{{else}}#{{/if}}">
              First
            </a>
            <a class="btn btn-outline-secondary btn-sm {{#unless pagination.prevUrl}}disabled{{/unless}}" href="{{#if pagination.prevUrl}}{{pagination.prevUrl}}{{else}}#{{/if}}">
              Prev
            </a>
            <a class="btn btn-outline-secondary btn-sm {{#unless pagination.nextUrl}}disabled{{/unless}}" href="{{#if pagination.nextUrl}}{{pagination.nextUrl}}{{else}}#{{/if}}">
              Next
            </a>
            <a class="btn btn-outline-secondary btn-sm {{#unless pagination.lastUrl}}disabled{{/unless}}" href="{{#if pagination.lastUrl}}{{pagination.lastUrl}}{{else}}#{{/if}}">
              Last
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
