<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Deployment</h1>
        <div>
          <span class="badge bg-primary me-2">Admin: {{user.email}}</span>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">
            <i class="fas fa-microchip"></i>
            CPU Utilization
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3 mb-4">
            <div class="col-sm-6 col-lg-3">
              <div class="border rounded p-3 h-100">
                <div class="text-muted small">Current Total</div>
                <div class="fs-3 fw-semibold" id="cpuCurrentAvg">
                  {{#if cpuMetrics.latest}}
                    {{#if (gt cpuMetrics.coreCount 0)}}
                      {{toFixed (multiply cpuMetrics.latest.avg cpuMetrics.coreCount) 1}}%
                    {{else}}
                      {{toFixed cpuMetrics.latest.avg 1}}%
                    {{/if}}
                  {{else}}
                    --
                  {{/if}}
                </div>
                <div class="text-muted small" id="cpuLastSample">
                  {{#if cpuMetrics.latest}}
                    Updated {{formatTimeAgoShortWithSeconds cpuMetrics.latest.ts}}
                  {{else}}
                    Collecting samples...
                  {{/if}}
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3">
              <div class="border rounded p-3 h-100">
                <div class="text-muted small">Core Range</div>
                <div class="fs-5 fw-semibold" id="cpuCoreRange">
                  {{#if cpuMetrics.latest}}
                    {{toFixed cpuMetrics.latest.min 1}}% - {{toFixed cpuMetrics.latest.max 1}}%
                  {{else}}
                    --
                  {{/if}}
                </div>
                <div class="text-muted small" id="cpuCoreSpread">
                  {{#if cpuMetrics.latest}}
                    Spread: {{toFixed (subtract cpuMetrics.latest.max cpuMetrics.latest.min) 1}}%
                  {{else}}
                    Spread: --
                  {{/if}}
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3">
              <div class="border rounded p-3 h-100">
                <div class="text-muted small">Cores</div>
                <div class="fs-3 fw-semibold" id="cpuCoreCount">
                  {{#if (gt cpuMetrics.coreCount 0)}}
                    {{cpuMetrics.coreCount}}
                  {{else}}
                    --
                  {{/if}}
                </div>
                <div class="text-muted small" id="cpuSampleInterval">
                  {{#if cpuMetrics.sampleIntervalMs}}
                    Sample interval: {{toFixed (divide cpuMetrics.sampleIntervalMs 1000) 0}}s
                  {{else}}
                    Sample interval: --
                  {{/if}}
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3">
              <div class="border rounded p-3 h-100">
                <div class="text-muted small">Uptime</div>
                <div class="fs-5 fw-semibold" id="cpuUptime">
                  {{#if cpuMetrics.uptimeMs}}
                    {{formatDurationMs cpuMetrics.uptimeMs}}
                  {{else}}
                    --
                  {{/if}}
                </div>
                <div class="text-muted small" id="cpuStartedAt">
                  {{#if cpuMetrics.startedAt}}
                    Started: {{formatDateTimeShort cpuMetrics.startedAt}}
                  {{else}}
                    Started: --
                  {{/if}}
                </div>
              </div>
            </div>
          </div>
          <div class="position-relative" style="height: 320px;">
            <div id="cpuChartEmptyState" class="text-muted small text-center py-5">
              Collecting CPU samples...
            </div>
            <canvas id="cpuUsageChart" class="w-100 h-100 d-none"></canvas>
          </div>
          <div class="text-muted small mt-2">
            The line shows total utilization across all cores (100% per core). History includes every sample since the
            last app start.
          </div>
        </div>
      </div>

      <!-- Deployment Management Section -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-server"></i>
            Deployment Management
          </h5>
        </div>
        <div class="card-body">
          {{#if deploymentControlsEnabled}}
            <p class="text-muted mb-3">
              <strong>Warning:</strong> Triggering a server update will pull the latest code from the repository, rebuild the application, and restart the server. This will cause a brief period of downtime.
            </p>
            <div class="d-flex gap-2 flex-wrap">
              <form method="POST" action="/admin/deployment/trigger-update" class="d-inline">
                  {{> csrf-field}}
                <button type="submit" class="btn btn-warning"
                  onclick="return confirm('Are you sure you want to trigger a server update? The application will be unavailable for a moment.')">
                  <i class="fas fa-sync-alt"></i> Trigger Server Update
                </button>
              </form>
              <form method="POST" action="/admin/deployment/restart-app" class="d-inline">
                  {{> csrf-field}}
                <button type="submit" class="btn btn-secondary"
                  onclick="return confirm('Restarting the web application will restart the PM2 process and disconnect users. Continue?')">
                  <i class="fas fa-redo"></i> Restart Application
                </button>
              </form>
              <form method="POST" action="/admin/deployment/restart-server" class="d-inline">
                  {{> csrf-field}}
                <button type="submit" class="btn btn-danger"
                  onclick="return confirm('Restarting the host server will reboot the entire machine and terminate all sessions. Continue?')">
                  <i class="fas fa-power-off"></i> Restart Host Server
                </button>
              </form>
            </div>
          {{else}}
            <div class="alert alert-info mb-0">
              Deployment controls are only available on Linux hosts running {{siteName}} via <code>deploy.sh</code> under PM2.
            </div>
          {{/if}}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const chartCanvas = document.getElementById('cpuUsageChart');
    if (!chartCanvas || typeof Chart === 'undefined') {
      return;
    }

    const cpuChartEmptyState = document.getElementById('cpuChartEmptyState');

    const dateFormatter = new Intl.DateTimeFormat(undefined, {
      month: 'short',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });

    let cpuChart = null;

    const formatPercent = (value) => {
      if (!Number.isFinite(value)) return '--';
      return `${value.toFixed(1)}%`;
    };


    const renderChart = (samples, coreCount) => {
      if (!Array.isArray(samples) || samples.length === 0) {
        chartCanvas.classList.add('d-none');
        cpuChartEmptyState.classList.remove('d-none');
        return;
      }

      chartCanvas.classList.remove('d-none');
      cpuChartEmptyState.classList.add('d-none');

      const labels = samples.map(sample => dateFormatter.format(new Date(sample.ts)));
      const totalSeries = samples.map(sample => sample.avg * coreCount);

      const chartData = {
        labels,
        datasets: [
          {
            label: 'Total Utilization',
            data: totalSeries,
            borderColor: 'rgba(32, 201, 151, 0.9)',
            backgroundColor: 'rgba(32, 201, 151, 0.08)',
            pointRadius: 0,
            tension: 0.2,
            order: 1
          }
        ]
      };

      const maxTotal = totalSeries.length ? Math.max(...totalSeries) : 100;
      const baseMax = Math.max(coreCount * 100, 100);
      const scaledMax = Math.max(baseMax, maxTotal);
      const yAxisMax = Math.ceil(scaledMax / 100) * 100;

      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        scales: {
          x: {
            ticks: {
              maxTicksLimit: 8
            }
          },
          y: {
            min: 0,
            max: yAxisMax,
            ticks: {
              callback: (value) => `${value}%`
            }
          }
        },
        plugins: {
          legend: {
            position: 'top'
          },
          tooltip: {
            callbacks: {
              label: (context) => `${context.dataset.label}: ${formatPercent(context.parsed.y)}`
            }
          }
        }
      };

      if (!cpuChart) {
        const ctx = chartCanvas.getContext('2d');
        cpuChart = new Chart(ctx, {
          type: 'line',
          data: chartData,
          options: chartOptions
        });
      } else {
        cpuChart.data.labels = chartData.labels;
        cpuChart.data.datasets = chartData.datasets;
        if (cpuChart.options && cpuChart.options.scales && cpuChart.options.scales.y) {
          cpuChart.options.scales.y.max = yAxisMax;
        }
        cpuChart.update('none');
      }
    };

    const cpuMetrics = {{{json cpuMetrics}}};
    const coreCount =
      cpuMetrics && Number.isFinite(cpuMetrics.coreCount) && cpuMetrics.coreCount > 0 ? cpuMetrics.coreCount : 1;
    renderChart(cpuMetrics ? cpuMetrics.samples : [], coreCount);
  });
</script>

