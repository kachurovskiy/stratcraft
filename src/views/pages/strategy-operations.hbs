<div class="container-fluid">
    <div class="row g-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center">
                <div>
                    <h1 class="h3 mb-2">Operations for {{strategy.name}}</h1>
                    {{#if strategyAccountSummary}}
                    <p class="text-muted mb-0">
                        Routed through {{strategyAccountSummary.name}} &middot; {{strategyAccountSummary.provider}} / {{strategyAccountSummary.environment}}
                    </p>
                    {{else}}
                    <p class="text-muted mb-0">Operations generated by this strategy.</p>
                    {{/if}}
                </div>
                <div class="mt-3 mt-lg-0 d-flex flex-wrap gap-2">
                    {{#if strategyAccountSummary}}
                    <a href="/accounts/{{strategyAccountSummary.id}}" class="btn btn-outline-primary">
                        <i class="fas fa-link me-2"></i>
                        View Account
                    </a>
                    {{/if}}
                    <a href="/strategies/{{strategy.id}}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Back to Strategy
                    </a>
                </div>
            </div>
        </div>

        <div class="col-12 col-xl-3">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>
                        Operation Summary
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {{#each statusSummary}}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="text-muted">{{label}}</span>
                            <span class="badge bg-{{badge}}">{{value}}</span>
                        </li>
                        {{/each}}
                    </ul>
                    <div class="mt-3 small text-muted">
                        Sorted by {{#each sortOptions}}{{#if (eq ../filters.sortBy value)}}{{label}}{{/if}}{{/each}}
                        ({{#if (eq filters.sortDirection 'asc')}}Oldest first{{else}}Most recent first{{/if}})
                    </div>
                    <div class="mt-2 small text-muted">
                        Showing {{pagination.from}}&ndash;{{pagination.to}} of {{pagination.total}} operations.
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-xl-9">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center">
                        <div>
                            <h5 class="card-title mb-1">
                                <i class="fas fa-list-ul me-2"></i>
                                Operation History
                            </h5>
                            <p class="text-muted mb-0">Filter by status, ticker, time range, or keyword.</p>
                        </div>
                        <form method="get" action="{{basePath}}" class="d-flex flex-wrap gap-2 mt-3 mt-lg-0">
                            {{#each baseQuery}}
                                {{#unless (eq @key 'pageSize')}}
                                    <input type="hidden" name="{{@key}}" value="{{this}}">
                                {{/unless}}
                            {{/each}}
                            <input type="hidden" name="page" value="1">
                            <div class="input-group input-group-sm">
                                <label class="input-group-text" for="pageSizeSelect">Page Size</label>
                                <select class="form-select" id="pageSizeSelect" name="pageSize" onchange="this.form.submit()">
                                    {{#each pageSizeOptions}}
                                        <option value="{{this}}" {{#if (eq ../filters.pageSize this)}}selected{{/if}}>
                                            {{this}}
                                        </option>
                                    {{/each}}
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card-body border-bottom">
                    <form method="get" action="{{basePath}}">
                        <input type="hidden" name="page" value="1">
                        <div class="row g-3">
                            <div class="col-md-4 col-lg-3">
                                <label for="statusSelect" class="form-label text-muted small mb-1">Status</label>
                                <select id="statusSelect" name="status" class="form-select">
                                    {{#each statusOptions}}
                                        <option value="{{value}}" {{#if (eq ../filters.status value)}}selected{{/if}}>{{label}}</option>
                                    {{/each}}
                                </select>
                            </div>
                            <div class="col-md-4 col-lg-3">
                                <label for="typeSelect" class="form-label text-muted small mb-1">Type</label>
                                <select id="typeSelect" name="type" class="form-select">
                                    {{#each operationTypeOptions}}
                                        <option value="{{value}}" {{#if (eq ../filters.type value)}}selected{{/if}}>{{label}}</option>
                                    {{/each}}
                                </select>
                            </div>
                            <div class="col-md-4 col-lg-3">
                                <label for="tickerInput" class="form-label text-muted small mb-1">Ticker</label>
                                <input id="tickerInput" name="ticker" value="{{filters.ticker}}" class="form-control" placeholder="e.g. AAPL">
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label for="searchInput" class="form-label text-muted small mb-1">Search</label>
                                <input id="searchInput" name="search" value="{{filters.search}}" class="form-control" placeholder="Reason, order ID, etc.">
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label for="fromInput" class="form-label text-muted small mb-1">From</label>
                                <input type="date" id="fromInput" name="from" value="{{filters.from}}" class="form-control">
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label for="toInput" class="form-label text-muted small mb-1">To</label>
                                <input type="date" id="toInput" name="to" value="{{filters.to}}" class="form-control">
                            </div>
                            <div class="col-md-6 col-lg-4">
                                <label for="sortSelect" class="form-label text-muted small mb-1">Sort</label>
                                <div class="input-group">
                                    <select id="sortSelect" name="sort" class="form-select">
                                        {{#each sortOptions}}
                                            <option value="{{value}}" {{#if (eq ../filters.sortBy value)}}selected{{/if}}>{{label}}</option>
                                        {{/each}}
                                    </select>
                                    <select name="direction" class="form-select">
                                        <option value="desc" {{#if (eq filters.sortDirection 'desc')}}selected{{/if}}>Desc</option>
                                        <option value="asc" {{#if (eq filters.sortDirection 'asc')}}selected{{/if}}>Asc</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-2 d-flex align-items-end">
                                <div class="btn-group w-100">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-filter me-2"></i>
                                        Apply
                                    </button>
                                    <a href="{{basePath}}" class="btn btn-outline-secondary">Reset</a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="table-responsive">
                    {{#if hasOperations}}
                    <table class="table table-sm align-middle mb-0 text-nowrap">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" class="ps-3">Triggered</th>
                                <th scope="col">Ticker</th>
                                <th scope="col">Type</th>
                                <th scope="col" class="text-end">Quantity</th>
                                <th scope="col" class="text-end">Price</th>
                                <th scope="col" class="text-end">Stop Loss</th>
                                <th scope="col">Status</th>
                                <th scope="col">Reason / Notes</th>
                                <th scope="col" class="text-end">Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each operations}}
                            <tr>
                                <td class="ps-3">{{formatDateTimeShort triggeredAt}}</td>
                                <td class="fw-semibold">{{ticker}}</td>
                                <td>{{operationTypeLabel operationType}}</td>
                                <td class="text-end">{{#if quantity}}{{quantity}}{{else}}&mdash;{{/if}}</td>
                                <td class="text-end">{{#if price}}{{formatPrice price}}{{else}}&mdash;{{/if}}</td>
                                <td class="text-end">{{#if stopLoss}}{{formatPrice stopLoss}}{{else}}&mdash;{{/if}}</td>
                                <td>
                                    <span class="badge bg-{{operationStatusBadge status}}">{{operationStatusLabel status}}</span>
                                    {{#if statusReason}}
                                        <div class="text-muted small mt-1">{{statusReason}}</div>
                                    {{/if}}
                                </td>
                                <td class="text-muted small">
                                    {{#if reason}}
                                        <div><span class="fw-semibold">Reason:</span> {{reason}}</div>
                                    {{/if}}
                                    {{#if orderId}}
                                        <div><span class="fw-semibold">Order ID:</span> {{orderId}}</div>
                                    {{/if}}
                                    {{#if (defined signalConfidence)}}
                                        <div><span class="fw-semibold">Confidence:</span> {{formatNumber signalConfidence 2}}</div>
                                    {{/if}}
                                    {{#if (defined daysHeld)}}
                                        <div><span class="fw-semibold">Days Held:</span> {{daysHeld}}</div>
                                    {{/if}}
                                    {{#if lastPayload}}
                                        <div class="mt-2">
                                            <details>
                                                <summary class="fw-semibold text-primary">Payload</summary>
                                                <pre class="bg-light border rounded p-2 mb-0 small text-break">{{json lastPayload}}</pre>
                                            </details>
                                        </div>
                                    {{/if}}
                                </td>
                                <td class="text-end">
                                    {{#if statusUpdatedAt}}
                                        {{formatDateTimeShort statusUpdatedAt}}
                                    {{else}}
                                        &mdash;
                                    {{/if}}
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                    {{else}}
                    <div class="alert alert-light border-0 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        No account operations match the current filters.
                    </div>
                    {{/if}}
                </div>
                {{#if hasOperations}}
                <div class="card-footer d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                    <div class="text-muted small mb-3 mb-md-0">
                        Showing {{pagination.from}}&ndash;{{pagination.to}} of {{pagination.total}} results
                    </div>
                    <div class="btn-group">
                        {{#if pagination.hasPrev}}
                            <a href="{{pagination.firstUrl}}" class="btn btn-outline-secondary btn-sm" title="First page">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                            <a href="{{pagination.prevUrl}}" class="btn btn-outline-secondary btn-sm" title="Previous page">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        {{else}}
                            <button class="btn btn-outline-secondary btn-sm" disabled>
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" disabled>
                                <i class="fas fa-angle-left"></i>
                            </button>
                        {{/if}}
                        <span class="btn btn-outline-secondary btn-sm disabled">Page {{pagination.page}} / {{pagination.totalPages}}</span>
                        {{#if pagination.hasNext}}
                            <a href="{{pagination.nextUrl}}" class="btn btn-outline-secondary btn-sm" title="Next page">
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="{{pagination.lastUrl}}" class="btn btn-outline-secondary btn-sm" title="Last page">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {{else}}
                            <button class="btn btn-outline-secondary btn-sm" disabled>
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" disabled>
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        {{/if}}
                    </div>
                </div>
                {{/if}}
            </div>
        </div>
    </div>
</div>
